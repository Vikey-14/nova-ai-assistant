name: macOS build (.app + DMG + PKG)
on:
  workflow_dispatch:
  push:
    tags: ["v*"]

jobs:
  build:
    runs-on: macos-13
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Homebrew deps
        run: |
          brew update
          brew install portaudio ffmpeg

      - name: Python deps
        run: |
          python -m pip install --upgrade pip wheel
          pip install -r requirements.macos.txt pyinstaller edge-tts gTTS playsound

      - name: Make .icns from assets/nova_icon_256.png
        run: |
          mkdir -p icons/nova.iconset
          sips -z 16 16  assets/nova_icon_256.png --out icons/nova.iconset/icon_16x16.png
          sips -z 32 32  assets/nova_icon_256.png --out icons/nova.iconset/icon_16x16@2x.png
          sips -z 32 32  assets/nova_icon_256.png --out icons/nova.iconset/icon_32x32.png
          sips -z 64 64  assets/nova_icon_256.png --out icons/nova.iconset/icon_32x32@2x.png
          sips -z 128 128 assets/nova_icon_256.png --out icons/nova.iconset/icon_128x128.png
          sips -z 256 256 assets/nova_icon_256.png --out icons/nova.iconset/icon_128x128@2x.png
          cp assets/nova_icon_256.png icons/nova.iconset/icon_512x512.png
          cp assets/nova_icon_256.png icons/nova.iconset/icon_512x512@2x.png
          iconutil -c icns icons/nova.iconset -o icons/nova.icns

      - name: Build apps with PyInstaller
        run: pyinstaller NOVA_Mac.spec

      - name: Make DMG
        run: |
          APPVER=${GITHUB_REF_NAME#v}
          mkdir -p dist_mac/NOVA-${APPVER}
          cp -R "dist/NOVA.app"          dist_mac/NOVA-${APPVER}/
          cp -R "dist/Nova Tray.app"     dist_mac/NOVA-${APPVER}/
          cp -R mac                      dist_mac/NOVA-${APPVER}/
          hdiutil create -volname "NOVA ${APPVER}" -srcfolder dist_mac/NOVA-${APPVER} -ov -format UDZO NOVA_${APPVER}_mac.dmg

      - name: Build PKG installer
        run: |
          APPVER=${GITHUB_REF_NAME#v}
          chmod +x mac/pkg/scripts/postinstall
          pkgbuild --identifier com.novaai.NOVA \
                   --version "$APPVER" \
                   --install-location /Applications \
                   --component "dist/NOVA.app" \
                   --component "dist/Nova Tray.app" \
                   --scripts mac/pkg/scripts \
                   NOVA_${APPVER}_mac.pkg

      - name: Install & verify PKG on runner (headless smoke test)
        shell: bash
        run: |
          APPVER=${GITHUB_REF_NAME#v}
          sudo installer -pkg "NOVA_${APPVER}_mac.pkg" -target /
          # Verify apps landed
          test -d "/Applications/NOVA.app"
          test -d "/Applications/Nova Tray.app"
          # Verify executables exist
          test -x "/Applications/NOVA.app/Contents/MacOS/NOVA"
          test -x "/Applications/Nova Tray.app/Contents/MacOS/NovaTray"
          # Verify LaunchAgent dropped and points to the tray binary
          test -f "/Library/LaunchAgents/com.novaai.tray.plist"
          /usr/libexec/PlistBuddy -c 'Print :ProgramArguments:0' /Library/LaunchAgents/com.novaai.tray.plist | grep -F "/Applications/Nova Tray.app/Contents/MacOS/NovaTray"
          echo "PKG install + layout verified."

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: NOVA-mac-${{ github.ref_name }}
          path: |
            dist/*.app
            NOVA_*_mac.dmg
            NOVA_*_mac.pkg
