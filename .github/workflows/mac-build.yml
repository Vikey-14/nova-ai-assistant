name: macOS build (.app + DMG)
on:
  workflow_dispatch:
  push:
    tags: ['v*']

jobs:
  build:
    runs-on: macos-13
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Homebrew deps
        run: |
          brew update
          brew install portaudio ffmpeg

      - name: Python deps
        run: |
          python -m pip install --upgrade pip wheel
          pip install -r requirements.macos.txt pyinstaller

      - name: Make .icns from assets/nova_icon_256.png
        run: |
          mkdir -p icons/nova.iconset
          sips -z 16 16  assets/nova_icon_256.png --out icons/nova.iconset/icon_16x16.png
          sips -z 32 32  assets/nova_icon_256.png --out icons/nova.iconset/icon_16x16@2x.png
          sips -z 32 32  assets/nova_icon_256.png --out icons/nova.iconset/icon_32x32.png
          sips -z 64 64  assets/nova_icon_256.png --out icons/nova.iconset/icon_32x32@2x.png
          sips -z 128 128 assets/nova_icon_256.png --out icons/nova.iconset/icon_128x128.png
          sips -z 256 256 assets/nova_icon_256.png --out icons/nova.iconset/icon_128x128@2x.png
          cp assets/nova_icon_256.png icons/nova.iconset/icon_512x512.png
          cp assets/nova_icon_256.png icons/nova.iconset/icon_512x512@2x.png
          iconutil -c icns icons/nova.iconset -o icons/nova.icns

      - name: Build apps with PyInstaller
        run: pyinstaller NOVA_Mac.spec

      - name: Smoke tests (headless)
        run: |
          # 1) Ensure the app executables exist
          test -x "dist/Nova.app/Contents/MacOS/Nova"
          test -x "dist/NovaTray.app/Contents/MacOS/NovaTray"

          # 2) Check Info.plist keys exist
          /usr/libexec/PlistBuddy -c 'Print :CFBundleIdentifier' dist/Nova.app/Contents/Info.plist
          /usr/libexec/PlistBuddy -c 'Print :CFBundleIdentifier' dist/NovaTray.app/Contents/Info.plist
          /usr/libexec/PlistBuddy -c 'Print :NSMicrophoneUsageDescription' dist/Nova.app/Contents/Info.plist

          # 3) Import core python modules (GUI/audio/objc)
          python - <<'PY'
          import importlib
          for m in ["tkinter","PIL","pyttsx3","speech_recognition","objc","AppKit","Foundation","Quartz","pyaudio"]:
              importlib.import_module(m)
          print("Smoke imports OK")
          PY

      - name: Make DMG
        run: |
          APPVER=${GITHUB_REF_NAME#v}
          mkdir -p dist_mac/Nova-${APPVER}
          cp -R dist/Nova.app dist_mac/Nova-${APPVER}/
          cp -R dist/NovaTray.app dist_mac/Nova-${APPVER}/
          cp -R mac dist_mac/Nova-${APPVER}/
          hdiutil create -volname "Nova ${APPVER}" -srcfolder dist_mac/Nova-${APPVER} -ov -format UDZO Nova_${APPVER}_mac.dmg

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Nova-mac-${{ github.ref_name }}
          path: |
            dist/Nova.app
            dist/NovaTray.app
            Nova_*_mac.dmg
